<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Landsat 8 å½±åƒé¢„å¤„ç†å·¥å…· - å¢å¼ºç‰ˆ</title>

  <!-- Element Plus CSS (æœ¬åœ°) -->
  <link rel="stylesheet" href="libs/element-plus.css">

  <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
        padding: 20px;
      }

      #app {
        max-width: 1400px;
        margin: 0 auto;
      }

      .app-header {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
        padding: 30px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .app-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .app-header p {
        font-size: 1.1em;
        color: #7f8c8d;
      }

      .main-container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-size: 1.3em;
        color: #2c3e50;
        margin: 25px 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
      }

      .upload-section {
        margin-bottom: 25px;
      }

      .band-preview {
        margin-top: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 6px;
      }

      .composite-tips {
        margin-top: 12px;
        padding: 12px;
        background-color: #f8f9fa;
        border-left: 3px solid #bdc3c7;
        border-radius: 4px;
        font-size: 14px;
        color: #606266;
      }

      /* å¢å¼ºçš„è¿›åº¦æ˜¾ç¤ºæ ·å¼ */
      .progress-container {
        padding: 25px;
        background: #f8f9fa;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .progress-title {
        font-size: 18px;
        font-weight: bold;
        color: #303133;
      }

      .progress-time {
        font-size: 14px;
        color: #606266;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .current-step-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #95a5a6;
      }

      .current-step-title {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .current-step-detail {
        font-size: 14px;
        color: #606266;
        line-height: 1.6;
      }

      .step-icon {
        display: inline-flex;
        width: 24px;
        height: 24px;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #95a5a6;
        color: white;
        font-size: 12px;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      .steps-timeline {
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: 8px;
      }

      .timeline-item {
        display: flex;
        align-items: flex-start;
        padding: 12px 0;
        position: relative;
      }

      .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: 12px;
        top: 36px;
        width: 2px;
        height: calc(100% - 12px);
        background: #e4e7ed;
      }

      .timeline-item.completed::after {
        background: #67c23a;
      }

      .timeline-item.active::after {
        background: linear-gradient(to bottom, #409eff, #e4e7ed);
      }

      .timeline-dot {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
        font-size: 12px;
        transition: all 0.3s ease;
      }

      .timeline-item.pending .timeline-dot {
        background: #e4e7ed;
        border: 2px solid #dcdfe6;
        color: #909399;
      }

      .timeline-item.active .timeline-dot {
        background: #95a5a6;
        border: 2px solid #95a5a6;
        color: white;
        box-shadow: 0 0 0 4px rgba(149, 165, 166, 0.2);
      }

      .timeline-item.completed .timeline-dot {
        background: #7f8c8d;
        border: 2px solid #7f8c8d;
        color: white;
      }

      @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .timeline-content {
        flex: 1;
      }

      .timeline-step-title {
        font-size: 14px;
        font-weight: 600;
        color: #303133;
        margin-bottom: 4px;
      }

      .timeline-item.pending .timeline-step-title {
        color: #909399;
      }

      .timeline-step-detail {
        font-size: 13px;
        color: #606266;
        line-height: 1.5;
      }

      .timeline-item.pending .timeline-step-detail {
        color: #c0c4cc;
      }

      .timeline-step-time {
        font-size: 12px;
        color: #909399;
        margin-top: 4px;
      }

      .info-card {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
        border-left: 4px solid #bdc3c7;
      }

      .footer {
        text-align: center;
        color: #7f8c8d;
        margin-top: 30px;
        padding: 20px;
      }

      @media (max-width: 768px) {
        .app-header h1 {
          font-size: 2em;
        }

        .main-container {
          padding: 20px;
        }
      }
    </style>
</head>
<body>
  <div id="app">
    <div class="app-header">
      <h1>ğŸ›°ï¸ Landsat 8 å½±åƒé¢„å¤„ç†å·¥å…·</h1>
      <p>ä¸€é”®å®Œæˆè¾å°„å®šæ ‡ã€å¤§æ°”æ ¡æ­£ã€äº‘æ©è†œã€è£å‰ªå’Œæ³¢æ®µåˆæˆ</p>
    </div>

    <div class="main-container">
      <el-tabs v-model="activeTab" type="card">
        <!-- å½±åƒå¤„ç†æ ‡ç­¾é¡µ -->
        <el-tab-pane label="ğŸ–¼ï¸ å½±åƒå¤„ç†" name="processing">
          <landsat8-processor></landsat8-processor>
        </el-tab-pane>

        <!-- æ³¢æ®µä¿¡æ¯æ ‡ç­¾é¡µ -->
        <el-tab-pane label="ğŸ“Š æ³¢æ®µä¿¡æ¯" name="bands">
          <band-info-panel></band-info-panel>
        </el-tab-pane>

        <!-- åˆæˆç±»å‹æ ‡ç­¾é¡µ -->
        <el-tab-pane label="ğŸ¨ åˆæˆç±»å‹" name="composites">
          <composite-types-panel></composite-types-panel>
        </el-tab-pane>

        <!-- å·¥å…·ç®±æ ‡ç­¾é¡µ -->
        <el-tab-pane label="ğŸ”§ å·¥å…·ç®±" name="tools">
          <tools-panel></tools-panel>
        </el-tab-pane>
      </el-tabs>
    </div>

    <div class="footer">
      <p>Â© 2025 LXD | Landsat8æ‰¹é‡å¤„ç†å·¥å…· v1.0.0 | åŸºäºFastAPIæ¡†æ¶å¼€å‘</p>
    </div>
  </div>

  <!-- Vue 3 (æœ¬åœ°) -->
  <script src="libs/vue.global.js"></script>

  <!-- Element Plus (æœ¬åœ°) -->
  <script src="libs/element-plus.js"></script>

  <!-- Element Plus Icons (æœ¬åœ°) -->
  <script src="libs/element-plus-icons.js"></script>

  <!-- Axios (æœ¬åœ°) -->
  <script src="libs/axios.min.js"></script>

  <script>
    const { createApp, ref, computed, reactive, onMounted } = Vue;
    const { ElMessage, ElMessageBox } = ElementPlus;

    const API_BASE_URL = 'http://localhost:5001';

    // æ³¢æ®µä¿¡æ¯é¢æ¿ç»„ä»¶
    const BandInfoPanelComponent = {
      name: 'BandInfoPanel',
      setup() {
        const bands = ref([]);
        const loading = ref(false);
        const satellite = ref('');
        const sensor = ref('');

        const fetchBandInfo = async () => {
          loading.value = true;
          try {
            const response = await axios.get(`${API_BASE_URL}/band_info`);
            bands.value = response.data.bands;
            satellite.value = response.data.satellite;
            sensor.value = response.data.sensor;
            ElMessage.success('æ³¢æ®µä¿¡æ¯åŠ è½½æˆåŠŸ');
          } catch (error) {
            ElMessage.error('åŠ è½½æ³¢æ®µä¿¡æ¯å¤±è´¥: ' + (error.response?.data?.detail || error.message));
          } finally {
            loading.value = false;
          }
        };

        onMounted(() => {
          fetchBandInfo();
        });

        return {
          bands,
          loading,
          satellite,
          sensor,
          fetchBandInfo
        };
      },
      template: `
        <div v-loading="loading">
          <h2 class="section-title">Landsat 8 æ³¢æ®µè¯¦ç»†ä¿¡æ¯</h2>

          <el-alert
            :title="satellite + ' ' + sensor"
            type="info"
            :closable="false"
            style="margin-bottom: 20px;"
          >
            Landsat 8æ­è½½OLIï¼ˆé™†åœ°æˆåƒä»ªï¼‰å’ŒTIRSï¼ˆçƒ­çº¢å¤–ä¼ æ„Ÿå™¨ï¼‰ï¼Œæä¾›11ä¸ªæ³¢æ®µçš„å¤šå…‰è°±æ•°æ®
          </el-alert>

          <el-table :data="bands" stripe style="width: 100%">
            <el-table-column prop="band" label="æ³¢æ®µ" width="80">
              <template #default="scope">
                <el-tag type="primary">{{ scope.row.band }}</el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="name" label="åç§°" width="120" />
            <el-table-column prop="wavelength" label="æ³¢é•¿èŒƒå›´" width="150" />
            <el-table-column prop="resolution" label="åˆ†è¾¨ç‡" width="100" />
            <el-table-column prop="use" label="ä¸»è¦ç”¨é€”" show-overflow-tooltip />
          </el-table>

          <div style="margin-top: 20px; text-align: center;">
            <el-button type="primary" @click="fetchBandInfo" :loading="loading">
              åˆ·æ–°æ³¢æ®µä¿¡æ¯
            </el-button>
          </div>
        </div>
      `
    };

    // åˆæˆç±»å‹é¢æ¿ç»„ä»¶
    const CompositeTypesPanelComponent = {
      name: 'CompositeTypesPanel',
      setup() {
        const compositeTypes = ref([]);
        const loading = ref(false);

        const fetchCompositeTypes = async () => {
          loading.value = true;
          try {
            const response = await axios.get(`${API_BASE_URL}/composite_types`);
            compositeTypes.value = response.data.composite_types;
            ElMessage.success('åˆæˆç±»å‹ä¿¡æ¯åŠ è½½æˆåŠŸ');
          } catch (error) {
            ElMessage.error('åŠ è½½åˆæˆç±»å‹å¤±è´¥: ' + (error.response?.data?.detail || error.message));
          } finally {
            loading.value = false;
          }
        };

        onMounted(() => {
          fetchCompositeTypes();
        });

        const getTypeColor = (type) => {
          const colors = {
            'true_color': '#67c23a',
            'false_color': '#e6a23c',
            'agriculture': '#909399',
            'urban': '#f56c6c',
            'natural_color': '#409eff',
            'swir': '#c71585',
            'ndvi': '#00ced1'
          };
          return colors[type] || '#409eff';
        };

        return {
          compositeTypes,
          loading,
          fetchCompositeTypes,
          getTypeColor
        };
      },
      template: `
        <div v-loading="loading">
          <h2 class="section-title">æ³¢æ®µåˆæˆç±»å‹è¯´æ˜</h2>

          <el-alert
            title="é€‰æ‹©åˆé€‚çš„åˆæˆç±»å‹"
            type="info"
            :closable="false"
            style="margin-bottom: 20px;"
          >
            ä¸åŒçš„æ³¢æ®µç»„åˆå¯ä»¥çªå‡ºä¸åŒçš„åœ°ç‰©ç‰¹å¾ï¼Œè¯·æ ¹æ®ç ”ç©¶ç›®çš„é€‰æ‹©åˆé€‚çš„åˆæˆæ–¹æ¡ˆ
          </el-alert>

          <el-row :gutter="20">
            <el-col :span="12" v-for="composite in compositeTypes" :key="composite.type" style="margin-bottom: 20px;">
              <el-card shadow="hover">
                <template #header>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; font-size: 16px;">{{ composite.name }}</span>
                    <el-tag :color="getTypeColor(composite.type)" style="color: white;">{{ composite.type }}</el-tag>
                  </div>
                </template>
                <div>
                  <p style="margin-bottom: 10px;">
                    <strong>æ³¢æ®µç»„åˆ:</strong> {{ composite.bands.join(' - ') }}
                  </p>
                  <p style="margin-bottom: 10px;">
                    <strong>è¯´æ˜:</strong> {{ composite.description }}
                  </p>
                  <el-divider style="margin: 12px 0;" />
                  <p style="color: #606266; font-size: 14px;">
                    <strong>åº”ç”¨åœºæ™¯:</strong> {{ composite.use_case }}
                  </p>
                </div>
              </el-card>
            </el-col>
          </el-row>

          <div style="margin-top: 20px; text-align: center;">
            <el-button type="primary" @click="fetchCompositeTypes" :loading="loading">
              åˆ·æ–°åˆæˆç±»å‹
            </el-button>
          </div>
        </div>
      `
    };

    // å·¥å…·ç®±é¢æ¿ç»„ä»¶
    const ToolsPanelComponent = {
      name: 'ToolsPanel',
      setup() {
        const mtlFile = ref([]);
        const mtlResult = ref(null);
        const mtlLoading = ref(false);

        const qaFile = ref([]);
        const qaResult = ref(null);
        const qaLoading = ref(false);
        const confidenceThreshold = ref('medium');

        // MTLæ–‡ä»¶è§£æ
        const parseMTL = async () => {
          if (mtlFile.value.length === 0) {
            ElMessage.warning('è¯·å…ˆé€‰æ‹©MTLæ–‡ä»¶');
            return;
          }

          mtlLoading.value = true;
          try {
            const formData = new FormData();
            formData.append('mtl_file', mtlFile.value[0].raw);

            const response = await axios.post(
              `${API_BASE_URL}/read_mtl`,
              formData,
              {
                headers: { 'Content-Type': 'multipart/form-data' }
              }
            );

            mtlResult.value = response.data;
            ElMessage.success('MTLæ–‡ä»¶è§£ææˆåŠŸ');
          } catch (error) {
            ElMessage.error('MTLæ–‡ä»¶è§£æå¤±è´¥: ' + (error.response?.data?.detail || error.message));
          } finally {
            mtlLoading.value = false;
          }
        };

        // äº‘æ©è†œåˆ†æ
        const analyzeCloudMask = async () => {
          if (qaFile.value.length === 0) {
            ElMessage.warning('è¯·å…ˆé€‰æ‹©QAæ³¢æ®µæ–‡ä»¶');
            return;
          }

          qaLoading.value = true;
          try {
            const formData = new FormData();
            formData.append('qa_band', qaFile.value[0].raw);
            formData.append('confidence_threshold', confidenceThreshold.value);

            const response = await axios.post(
              `${API_BASE_URL}/extract_cloud_mask`,
              formData,
              {
                headers: { 'Content-Type': 'multipart/form-data' }
              }
            );

            qaResult.value = response.data;
            ElMessage.success(response.data.message);
          } catch (error) {
            ElMessage.error('äº‘æ©è†œåˆ†æå¤±è´¥: ' + (error.response?.data?.detail || error.message));
          } finally {
            qaLoading.value = false;
          }
        };

        return {
          mtlFile,
          mtlResult,
          mtlLoading,
          parseMTL,
          qaFile,
          qaResult,
          qaLoading,
          confidenceThreshold,
          analyzeCloudMask
        };
      },
      template: `
        <div>
          <h2 class="section-title">ğŸ”§ å·¥å…·ç®±</h2>

          <!-- MTLæ–‡ä»¶è§£æ -->
          <el-card style="margin-bottom: 20px;">
            <template #header>
              <div style="font-weight: bold;">ğŸ“‹ MTLå…ƒæ•°æ®è§£æ</div>
            </template>
            <el-form label-width="120px">
              <el-form-item label="MTLæ–‡ä»¶:">
                <el-upload
                  v-model:file-list="mtlFile"
                  :auto-upload="false"
                  :limit="1"
                  accept=".txt"
                >
                  <el-button type="primary">é€‰æ‹©MTLæ–‡ä»¶</el-button>
                  <template #tip>
                    <div class="el-upload__tip">
                      é€‰æ‹© *_MTL.txt å…ƒæ•°æ®æ–‡ä»¶è¿›è¡Œè§£æ
                    </div>
                  </template>
                </el-upload>
              </el-form-item>

              <el-form-item>
                <el-button
                  type="success"
                  @click="parseMTL"
                  :loading="mtlLoading"
                  :disabled="mtlFile.length === 0"
                >
                  è§£æMTLæ–‡ä»¶
                </el-button>
              </el-form-item>
            </el-form>

            <div v-if="mtlResult" style="margin-top: 20px;">
              <el-alert
                title="MTLæ–‡ä»¶è§£æç»“æœ"
                type="success"
                :closable="false"
                style="margin-bottom: 15px;"
              />
              <el-descriptions :column="2" border>
                <el-descriptions-item label="æ–‡ä»¶å">{{ mtlResult.filename }}</el-descriptions-item>
                <el-descriptions-item label="åœºæ™¯ID">{{ mtlResult.metadata.scene_id }}</el-descriptions-item>
                <el-descriptions-item label="é‡‡é›†æ—¥æœŸ">{{ mtlResult.metadata.date_acquired }}</el-descriptions-item>
                <el-descriptions-item label="å¤ªé˜³é«˜åº¦è§’">{{ mtlResult.metadata.sun_elevation }}Â°</el-descriptions-item>
                <el-descriptions-item label="å¤ªé˜³æ–¹ä½è§’">{{ mtlResult.metadata.sun_azimuth }}Â°</el-descriptions-item>
                <el-descriptions-item label="äº‘è¦†ç›–ç‡">{{ mtlResult.metadata.cloud_cover }}%</el-descriptions-item>
              </el-descriptions>
            </div>
          </el-card>

          <!-- äº‘æ©è†œåˆ†æ -->
          <el-card>
            <template #header>
              <div style="font-weight: bold;">â˜ï¸ äº‘æ©è†œåˆ†æ</div>
            </template>
            <el-form label-width="120px">
              <el-form-item label="QAæ³¢æ®µ:">
                <el-upload
                  v-model:file-list="qaFile"
                  :auto-upload="false"
                  :limit="1"
                  accept=".tif,.tiff,.img"
                >
                  <el-button type="primary">é€‰æ‹©QAæ³¢æ®µ</el-button>
                  <template #tip>
                    <div class="el-upload__tip">
                      é€‰æ‹© *_BQA.TIF è´¨é‡è¯„ä»·æ³¢æ®µ
                    </div>
                  </template>
                </el-upload>
              </el-form-item>

              <el-form-item label="ç½®ä¿¡åº¦é˜ˆå€¼:">
                <el-radio-group v-model="confidenceThreshold">
                  <el-radio label="low">ä½</el-radio>
                  <el-radio label="medium">ä¸­</el-radio>
                  <el-radio label="high">é«˜</el-radio>
                </el-radio-group>
                <div style="font-size: 12px; color: #909399; margin-top: 5px;">
                  é˜ˆå€¼è¶Šé«˜ï¼Œäº‘æ£€æµ‹è¶Šä¸¥æ ¼
                </div>
              </el-form-item>

              <el-form-item>
                <el-button
                  type="success"
                  @click="analyzeCloudMask"
                  :loading="qaLoading"
                  :disabled="qaFile.length === 0"
                >
                  åˆ†æäº‘æ©è†œ
                </el-button>
              </el-form-item>
            </el-form>

            <div v-if="qaResult" style="margin-top: 20px;">
              <el-alert
                :title="'äº‘è¦†ç›–ç‡: ' + qaResult.statistics.cloud_percentage + '%'"
                :type="qaResult.statistics.cloud_percentage > 50 ? 'warning' : 'success'"
                :closable="false"
                style="margin-bottom: 15px;"
              />
              <el-descriptions :column="2" border>
                <el-descriptions-item label="æ–‡ä»¶å">{{ qaResult.filename }}</el-descriptions-item>
                <el-descriptions-item label="ç½®ä¿¡åº¦é˜ˆå€¼">{{ qaResult.statistics.confidence_threshold }}</el-descriptions-item>
                <el-descriptions-item label="æ€»åƒå…ƒæ•°">{{ qaResult.statistics.total_pixels.toLocaleString() }}</el-descriptions-item>
                <el-descriptions-item label="äº‘åƒå…ƒæ•°">{{ qaResult.statistics.cloud_pixels.toLocaleString() }}</el-descriptions-item>
                <el-descriptions-item label="æ™´ç©ºåƒå…ƒæ•°">{{ qaResult.statistics.clear_pixels.toLocaleString() }}</el-descriptions-item>
                <el-descriptions-item label="å½±åƒå°ºå¯¸">{{ qaResult.shape[0] }} Ã— {{ qaResult.shape[1] }}</el-descriptions-item>
              </el-descriptions>

              <div style="margin-top: 15px;">
                <el-progress
                  :percentage="qaResult.statistics.cloud_percentage"
                  :color="qaResult.statistics.cloud_percentage > 50 ? '#f56c6c' : '#67c23a'"
                  :stroke-width="20"
                >
                  <span style="color: #606266;">äº‘è¦†ç›–ç‡</span>
                </el-progress>
              </div>
            </div>
          </el-card>
        </div>
      `
    };

    const Landsat8ProcessorComponent = {
      name: 'Landsat8Processor',
      setup() {
        const form = reactive({
          outputDir: 'E:\\Landsat8_Output',
          clipExtent: '',
          createComposites: ['true_color'],
          applyCloudMask: false
        });

        const bandFiles = ref([]);
        const mtlFile = ref([]);
        const qaFile = ref([]);
        const shapeFiles = ref([]);
        const bandMap = ref({});
        const processing = ref(false);
        const processingResult = ref(null);
        const progressPercentage = ref(0);
        const progressStatus = ref('');
        const statusText = ref('');
        const selectingFolder = ref(false);

        // æ–°å¢: å¤„ç†æ­¥éª¤è¿½è¸ª
        const processingSteps = ref([
          { id: 1, title: 'ä¸Šä¼ æ–‡ä»¶', detail: 'æ­£åœ¨ä¸Šä¼ æ³¢æ®µæ–‡ä»¶åˆ°æœåŠ¡å™¨', status: 'pending', time: '' },
          { id: 2, title: 'è§£æå…ƒæ•°æ®', detail: 'è¯»å–MTLæ–‡ä»¶å’Œå½±åƒä¿¡æ¯', status: 'pending', time: '' },
          { id: 3, title: 'è¾å°„å®šæ ‡', detail: 'DNå€¼è½¬æ¢ä¸ºåœ°è¡¨åå°„ç‡', status: 'pending', time: '' },
          { id: 4, title: 'å¤§æ°”æ ¡æ­£', detail: 'DOSæš—ç›®æ ‡æ³•å¤§æ°”æ ¡æ­£', status: 'pending', time: '' },
          { id: 5, title: 'äº‘æ©è†œå¤„ç†', detail: 'æå–å¹¶åº”ç”¨äº‘æ©è†œ', status: 'pending', time: '' },
          { id: 6, title: 'å½±åƒè£å‰ª', detail: 'æŒ‰æŒ‡å®šèŒƒå›´è£å‰ªå½±åƒ', status: 'pending', time: '' },
          { id: 7, title: 'æ³¢æ®µåˆæˆ', detail: 'ç”Ÿæˆåˆæˆå½±åƒ', status: 'pending', time: '' },
          { id: 8, title: 'ä¿å­˜ç»“æœ', detail: 'å†™å…¥è¾“å‡ºæ–‡ä»¶', status: 'pending', time: '' },
          { id: 9, title: 'å®Œæˆ', detail: 'å¤„ç†å®Œæˆï¼Œç”Ÿæˆæ‘˜è¦', status: 'pending', time: '' }
        ]);

        const currentStepIndex = ref(-1);
        const startTime = ref(null);
        const elapsedTime = ref('00:00');

        const canStartProcessing = computed(() => {
          return Object.keys(bandMap.value).length > 0 && !processing.value && form.outputDir;
        });

        const currentStep = computed(() => {
          if (currentStepIndex.value >= 0 && currentStepIndex.value < processingSteps.value.length) {
            return processingSteps.value[currentStepIndex.value];
          }
          return null;
        });

        // æ ¼å¼åŒ–æ—¶é—´
        const formatTime = (seconds) => {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        // æ›´æ–°ç»è¿‡æ—¶é—´
        let timeInterval = null;
        const updateElapsedTime = () => {
          if (startTime.value) {
            const elapsed = Math.floor((Date.now() - startTime.value) / 1000);
            elapsedTime.value = formatTime(elapsed);
          }
        };

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        const updateStep = (index, status) => {
          if (index >= 0 && index < processingSteps.value.length) {
            processingSteps.value[index].status = status;
            if (status === 'active') {
              processingSteps.value[index].time = new Date().toLocaleTimeString();
            } else if (status === 'completed') {
              processingSteps.value[index].time = elapsedTime.value;
            }
            currentStepIndex.value = index;
          }
        };

        const extractBandName = (filename) => {
          const upperFilename = filename.toUpperCase();
          for (let i = 1; i <= 11; i++) {
            if (upperFilename.includes(`B${i}.`) || upperFilename.includes(`_B${i}.`)) {
              return `B${i}`;
            }
          }
          return null;
        };

        const handleBandChange = (file) => {
          const bandName = extractBandName(file.name);
          if (bandName) {
            bandMap.value[bandName] = file.raw;
            ElMessage.success(`å·²è¯†åˆ«æ³¢æ®µ ${bandName}`);
          } else {
            ElMessage.warning(`æ— æ³•è¯†åˆ«æ³¢æ®µ: ${file.name}`);
          }
        };

        const handleBandRemove = (file) => {
          const bandName = extractBandName(file.name);
          if (bandName && bandMap.value[bandName]) {
            delete bandMap.value[bandName];
          }
        };

        const startProcessing = async () => {
          if (Object.keys(bandMap.value).length === 0) {
            ElMessage.error('è¯·è‡³å°‘ä¸Šä¼ ä¸€ä¸ªæ³¢æ®µæ–‡ä»¶');
            return;
          }

          processing.value = true;
          progressPercentage.value = 0;
          processingResult.value = null;
          startTime.value = Date.now();
          currentStepIndex.value = 0;

          // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
          processingSteps.value.forEach(step => {
            step.status = 'pending';
            step.time = '';
          });

          // å¯åŠ¨è®¡æ—¶å™¨
          timeInterval = setInterval(updateElapsedTime, 1000);

          try {
            const formData = new FormData();

            // æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶
            updateStep(0, 'active');
            progressPercentage.value = 5;
            await new Promise(resolve => setTimeout(resolve, 500));

            Object.values(bandMap.value).forEach(file => {
              formData.append('bands', file);
            });

            if (mtlFile.value.length > 0) {
              formData.append('mtl_file', mtlFile.value[0].raw);
            }

            if (qaFile.value.length > 0) {
              formData.append('qa_band', qaFile.value[0].raw);
            }

            formData.append('output_dir', form.outputDir);

            if (form.createComposites.length > 0) {
              formData.append('create_composites', form.createComposites.join(','));
            }

            formData.append('apply_cloud_mask', form.applyCloudMask.toString());

            updateStep(0, 'completed');

            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            const stepDurations = [0, 10, 20, 35, 50, 60, 70, 85, 95];
            let stepIndex = 1;

            const progressInterval = setInterval(() => {
              if (stepIndex < processingSteps.value.length && processing.value) {
                updateStep(stepIndex - 1, 'completed');
                updateStep(stepIndex, 'active');
                progressPercentage.value = stepDurations[stepIndex] || progressPercentage.value;
                stepIndex++;
              } else {
                clearInterval(progressInterval);
              }
            }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡æ­¥éª¤

            const response = await axios.post(
              `${API_BASE_URL}/preprocess_landsat8`,
              formData,
              {
                headers: { 'Content-Type': 'multipart/form-data' },
                timeout: 300000
              }
            );

            clearInterval(progressInterval);
            clearInterval(timeInterval);

            // æ ‡è®°æ‰€æœ‰æ­¥éª¤å®Œæˆ
            processingSteps.value.forEach((step, index) => {
              if (step.status !== 'completed') {
                updateStep(index, 'completed');
              }
            });

            progressPercentage.value = 100;
            progressStatus.value = 'success';
            processingResult.value = response.data;

            ElMessage.success({
              message: 'å½±åƒé¢„å¤„ç†å®Œæˆï¼',
              duration: 3000,
              showClose: true
            });
          } catch (error) {
            clearInterval(timeInterval);
            progressPercentage.value = 100;
            progressStatus.value = 'exception';

            // æ ‡è®°å½“å‰æ­¥éª¤ä¸ºå¤±è´¥
            if (currentStepIndex.value >= 0) {
              processingSteps.value[currentStepIndex.value].status = 'exception';
            }

            ElMessage.error('å¤„ç†å¤±è´¥: ' + (error.response?.data?.detail || error.message));
          } finally {
            processing.value = false;
          }
        };

        // é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹
        const selectOutputFolder = async () => {
          selectingFolder.value = true;
          try {
            const response = await axios.get(`${API_BASE_URL}/select_folder`);

            if (response.data.status === 'success' && response.data.path) {
              form.outputDir = response.data.path;
              ElMessage.success('æ–‡ä»¶å¤¹é€‰æ‹©æˆåŠŸ');
            } else if (response.data.status === 'cancelled') {
              ElMessage.info('å·²å–æ¶ˆé€‰æ‹©');
            }
          } catch (error) {
            ElMessage.error('æ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†å¤±è´¥: ' + (error.response?.data?.detail || error.message));
          } finally {
            selectingFolder.value = false;
          }
        };

        const resetForm = () => {
          Object.assign(form, {
            outputDir: 'E:\\Landsat8_Output',
            clipExtent: '',
            createComposites: ['true_color'],
            applyCloudMask: false
          });
          bandFiles.value = [];
          mtlFile.value = [];
          qaFile.value = [];
          bandMap.value = {};
          processingResult.value = null;
          progressPercentage.value = 0;
          progressStatus.value = '';
          currentStepIndex.value = -1;
          elapsedTime.value = '00:00';
          processingSteps.value.forEach(step => {
            step.status = 'pending';
            step.time = '';
          });
        };

        return {
          form,
          bandFiles,
          mtlFile,
          qaFile,
          bandMap,
          processing,
          processingResult,
          progressPercentage,
          progressStatus,
          statusText,
          processingSteps,
          currentStep,
          currentStepIndex,
          elapsedTime,
          canStartProcessing,
          selectingFolder,
          handleBandChange,
          handleBandRemove,
          startProcessing,
          selectOutputFolder,
          resetForm
        };
      },
      template: `
        <div>
          <el-form :model="form" label-width="140px" size="default">
            <!-- æ³¢æ®µæ–‡ä»¶ä¸Šä¼  -->
            <div class="upload-section">
              <h3 class="section-title">ğŸ“ æ³¢æ®µæ–‡ä»¶</h3>
              <el-upload
                v-model:file-list="bandFiles"
                :auto-upload="false"
                :on-change="handleBandChange"
                :on-remove="handleBandRemove"
                multiple
                drag
                accept=".tif,.tiff,.img"
              >
                <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                <div class="el-upload__text">
                  æ‹–æ‹½ Landsat 8 æ³¢æ®µæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em>
                </div>
                <template #tip>
                  <div class="el-upload__tip">
                    æ”¯æŒ .tif, .tiff, .img æ ¼å¼ï¼Œæ–‡ä»¶ååº”åŒ…å«æ³¢æ®µç¼–å·
                  </div>
                </template>
              </el-upload>

              <div v-if="Object.keys(bandMap).length > 0" class="band-preview">
                <h4>å·²è¯†åˆ«æ³¢æ®µ:</h4>
                <el-tag
                  v-for="(file, band) in bandMap"
                  :key="band"
                  type="success"
                  style="margin: 4px;"
                >
                  {{ band }}
                </el-tag>
              </div>
            </div>

            <!-- MTLå’ŒQAæ–‡ä»¶ -->
            <div class="upload-section">
              <h3 class="section-title">ğŸ“‹ å…ƒæ•°æ®æ–‡ä»¶ (å¯é€‰)</h3>
              <el-form-item label="MTLå…ƒæ•°æ®:">
                <el-upload
                  v-model:file-list="mtlFile"
                  :auto-upload="false"
                  :limit="1"
                  accept=".txt"
                >
                  <el-button type="primary">é€‰æ‹©MTLæ–‡ä»¶</el-button>
                </el-upload>
              </el-form-item>

              <el-form-item label="QAæ³¢æ®µ:">
                <el-upload
                  v-model:file-list="qaFile"
                  :auto-upload="false"
                  :limit="1"
                  accept=".tif,.tiff,.img"
                >
                  <el-button type="primary">é€‰æ‹©QAæ³¢æ®µ</el-button>
                </el-upload>
              </el-form-item>
            </div>

            <!-- è¾“å‡ºè®¾ç½® -->
            <div class="upload-section">
              <h3 class="section-title">ğŸ’¾ è¾“å‡ºè®¾ç½®</h3>
              <el-form-item label="è¾“å‡ºç›®å½•:">
                <div style="display: flex; gap: 10px;">
                  <el-input
                    v-model="form.outputDir"
                    placeholder="è¾“å‡ºè·¯å¾„"
                    clearable
                    style="flex: 1;"
                  />
                  <el-button
                    type="primary"
                    @click="selectOutputFolder"
                    :loading="selectingFolder"
                  >
                    <el-icon><folder-opened /></el-icon>
                    æµè§ˆ
                  </el-button>
                </div>
              </el-form-item>
            </div>

            <!-- åˆæˆå½±åƒè®¾ç½® -->
            <div class="upload-section">
              <h3 class="section-title">ğŸ¨ åˆæˆå½±åƒç±»å‹</h3>
              <el-form-item>
                <el-checkbox-group v-model="form.createComposites">
                  <el-checkbox label="true_color">çœŸå½©è‰²</el-checkbox>
                  <el-checkbox label="false_color">å‡å½©è‰²</el-checkbox>
                  <el-checkbox label="agriculture">å†œä¸š</el-checkbox>
                  <el-checkbox label="urban">åŸå¸‚</el-checkbox>
                  <el-checkbox label="ndvi">NDVI</el-checkbox>
                </el-checkbox-group>
              </el-form-item>
            </div>

            <!-- äº‘æ©è†œè®¾ç½® -->
            <div class="upload-section">
              <h3 class="section-title">â˜ï¸ äº‘æ©è†œè®¾ç½®</h3>
              <el-form-item label="åº”ç”¨äº‘æ©è†œ:">
                <el-switch
                  v-model="form.applyCloudMask"
                  :disabled="!qaFile.length"
                />
              </el-form-item>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <el-form-item>
              <el-button
                type="primary"
                @click="startProcessing"
                :loading="processing"
                :disabled="!canStartProcessing"
                size="large"
              >
                <span v-if="!processing">å¼€å§‹é¢„å¤„ç†</span>
                <span v-else>å¤„ç†ä¸­...</span>
              </el-button>

              <el-button @click="resetForm" size="large" :disabled="processing">
                é‡ç½®
              </el-button>
            </el-form-item>
          </el-form>

          <!-- å¢å¼ºçš„è¿›åº¦æ˜¾ç¤º -->
          <div v-if="processing || processingResult" class="progress-container">
            <div class="progress-header">
              <div class="progress-title">
                <span v-if="processing">ğŸš€ å¤„ç†è¿›è¡Œä¸­</span>
                <span v-else-if="progressStatus === 'success'">âœ… å¤„ç†å®Œæˆ</span>
                <span v-else-if="progressStatus === 'exception'">âŒ å¤„ç†å¤±è´¥</span>
              </div>
              <div class="progress-time">
                <el-icon><clock /></el-icon>
                <span>å·²ç”¨æ—¶: {{ elapsedTime }}</span>
              </div>
            </div>

            <!-- å½“å‰æ­¥éª¤å¡ç‰‡ -->
            <div v-if="processing && currentStep" class="current-step-card">
              <div class="current-step-title">
                <span class="step-icon">âš™</span>
                {{ currentStep.title }}
              </div>
              <div class="current-step-detail">
                {{ currentStep.detail }}
              </div>
            </div>

            <!-- æ€»ä½“è¿›åº¦æ¡ -->
            <el-progress
              :percentage="progressPercentage"
              :status="progressStatus"
              :stroke-width="16"
              :show-text="true"
              style="margin-bottom: 20px;"
            >
              <template #default="{ percentage }">
                <span style="font-weight: 600;">{{ percentage }}%</span>
              </template>
            </el-progress>

            <!-- æ­¥éª¤æ—¶é—´çº¿ -->
            <div class="steps-timeline">
              <div
                v-for="step in processingSteps"
                :key="step.id"
                :class="['timeline-item', step.status]"
              >
                <div class="timeline-dot">
                  <span v-if="step.status === 'completed'">âœ“</span>
                  <span v-else-if="step.status === 'active'">âš™</span>
                  <span v-else>{{ step.id }}</span>
                </div>
                <div class="timeline-content">
                  <div class="timeline-step-title">{{ step.title }}</div>
                  <div class="timeline-step-detail">{{ step.detail }}</div>
                  <div v-if="step.time" class="timeline-step-time">
                    <el-icon><clock /></el-icon>
                    {{ step.time }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- å¤„ç†ç»“æœ -->
          <div v-if="processingResult">
            <h3 class="section-title">ğŸ“Š å¤„ç†ç»“æœ</h3>

            <el-alert
              v-if="processingResult.status === 'success'"
              title="âœ… å¤„ç†æˆåŠŸï¼"
              type="success"
              :closable="false"
              show-icon
              style="margin-bottom: 15px;"
            />

            <div v-if="processingResult.summary" style="margin-top: 15px;">
              <el-descriptions :column="2" border>
                <el-descriptions-item label="å¤„ç†æ³¢æ®µæ•°">
                  <el-tag type="success">{{ processingResult.summary.total_bands_processed }} ä¸ª</el-tag>
                </el-descriptions-item>
                <el-descriptions-item label="åˆæˆå½±åƒæ•°">
                  <el-tag type="primary">{{ processingResult.summary.composites_created }} ä¸ª</el-tag>
                </el-descriptions-item>
                <el-descriptions-item label="è¾“å‡ºç›®å½•" :span="2">
                  <el-text type="primary" style="word-break: break-all;">
                    {{ processingResult.summary.output_directory }}
                  </el-text>
                </el-descriptions-item>
              </el-descriptions>
            </div>

            <div v-if="processingResult.composites && Object.keys(processingResult.composites).length > 0" style="margin-top: 15px;">
              <h4>ğŸ¨ åˆæˆå½±åƒæ–‡ä»¶:</h4>
              <el-table :data="Object.entries(processingResult.composites).map(([k,v]) => ({type: k, path: v}))" stripe style="margin-top: 10px;">
                <el-table-column prop="type" label="ç±»å‹" width="150">
                  <template #default="scope">
                    <el-tag>{{ scope.row.type }}</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="path" label="æ–‡ä»¶è·¯å¾„" show-overflow-tooltip />
              </el-table>
            </div>
          </div>
        </div>
      `
    };

    // åˆ›å»º Vue åº”ç”¨
    const app = createApp({
      setup() {
        const activeTab = ref('processing');

        return {
          activeTab
        };
      },
      components: {
        'landsat8-processor': Landsat8ProcessorComponent,
        'band-info-panel': BandInfoPanelComponent,
        'composite-types-panel': CompositeTypesPanelComponent,
        'tools-panel': ToolsPanelComponent
      }
    });

    // æ³¨å†Œ Element Plus
    app.use(ElementPlus);

    // æ³¨å†Œ Element Plus Icons
    if (typeof ElementPlusIconsVue !== 'undefined') {
      for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);
      }
    }

    // æŒ‚è½½åº”ç”¨
    app.mount('#app');
  </script>
</body>
</html>
